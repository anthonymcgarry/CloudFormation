AWSTemplateFormatVersion: '2010-09-09'
Description: AWS CloudFormation Network Stack for Transit Gateway
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Transit Gateway Configuration
        Parameters:
          - TGWASN00
    ParameterLabels:
      TGWASN00:
        default: Transit Gateway AS Number
Parameters:
  TGWASN00:
    AllowedPattern: ^42000203\d{2}$ # 32 bit ASN range 42000203xx assinged for transit gateways
    Description: VPCStack VPC ID
    Type: String
    Default: "4200020300"
  TGW00Route01:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(?:[0-9]|1[0-9]?|2[0-9]?|3[0-2]?))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.0.0/8
    Description: Route in CIDR notation 
    Type: String
Resources:
  TGW00:
    Type: AWS::EC2::TransitGateway
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties: 
      AmazonSideAsn: !Ref TGWASN00
      AutoAcceptSharedAttachments: "disable"
      DefaultRouteTableAssociation: "disable"
      DefaultRouteTablePropagation: "disable"
      Description: "Primary transit gateway"
      DnsSupport: "enable"
      VpnEcmpSupport: "enable"
      Tags: 
      - Key: Name
        Value: adminip-prod-euw1-asn20300-tgw
  TGW00Att01:
    Type: AWS::EC2::TransitGatewayAttachment
    Properties:
      SubnetIds: 
        - !ImportValue adminip-dev-infra-network-stack-SubnetStack-6XI2NFAJH1B3-EdgeSubnet1
        - !ImportValue adminip-dev-infra-network-stack-SubnetStack-6XI2NFAJH1B3-EdgeSubnet2
        - !ImportValue adminip-dev-infra-network-stack-SubnetStack-6XI2NFAJH1B3-EdgeSubnet3
      TransitGatewayId: !Ref TGW00
      VpcId: !ImportValue adminip-dev-infra-network-stack-VPCStack-1RLV4FSAWCJSU-VPCID
      Tags: 
      - Key: Name
        Value: adminip-dev-vpc-ip-att
  TGW00Rtb01:
    Type: AWS::EC2::TransitGatewayRouteTable
    Properties: 
      TransitGatewayId: !Ref TGW00
      Tags: 
      - Key: Name
        Value: adminip-dev-vpc-rtb
  TGW00Rtb01Assoc:
    Type: AWS::EC2::TransitGatewayRouteTableAssociation
    Properties: 
      TransitGatewayAttachmentId: !Ref TGW00Att01
      TransitGatewayRouteTableId: !Ref TGW00Rtb01
  TGW00Rtb01Prop:  
    Type: AWS::EC2::TransitGatewayRouteTablePropagation
    Properties: 
      TransitGatewayAttachmentId: !Ref # attachment where routes are propagatig from
      TransitGatewayRouteTableId: !Ref TGW00Rtb01
  TGW00Rtb01Route01:
    Type: 'AWS::EC2::Route'
    Properties:
      DestinationCidrBlock: !Ref TGW00Route01
      RouteTableId: !Ref TGW00Rtb01
      TransitGatewayId: !Ref TGW00
